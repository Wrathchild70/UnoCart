mads 2.0.6 build 58 (28 Jan 17)
Source: Mode7FFL3.asm
     1 				/* Mode-7 Demo ROM for use with UnoCart
     2 				 * by Mark Keates/Wrathchild@AtariAge
     3 				 * This file builds with WUDSN/MADS into an 8K Atari ROM
     4 				 * The 8k ROM is loaded with the Final Fantasy/VRAM from Pokemon:
     5 				 */
     5
     6
     7 = 0030			CART_CMD_REFRESH_M7_SCREEN = $30
     8 = 0031			CART_CMD_INIT_M7_VRAM = $31
     9 = 0032			CART_CMD_PROCESS_MOVEMENT = $32
    10
    11 				;@com.wudsn.ide.asm.outputfileextension=.rom
    12
    13 = 0080			CARTFG_DIAGNOSTIC_CART = $80       ;Flag value: Directly jump via CARTAD during RESET.
    14 = 0004			CARTFG_START_CART      = $04       ;Flag value: Jump via CARTAD and then via CARTCS.
    15 = 0001			CARTFG_BOOT            = $01       ;Flag value: Boot peripherals, then start the module.
    16
    17 = E45C			SETVBV = $E45C
    18 = E462			XITVBV = $E462
    19 = E477			COLDSV = $E477				; Coldstart (powerup) entry point
    20 = E474			WARMSV = $E474				; Warmstart entry point
    21
    22 = D01A			COLBAK = $D01A
    23 = D01F			CONSOL = $D01F
    24 = D301			PORTB = $D301
    25 = D400			DMACTL = $D400
    26 = D404			HSCROL = $D404
    27 = D407			PMBASE = $D407
    28 = D40E			NMIEN = $D40E
    29
    30 = 022F			SDMCTL = $22F
    31 = 026F			GPRIOR = $26F
    32 = 02C0			PCOLR0 = $2C0
    33 = 02C1			PCOLR1 = $2C1
    34 = 02C2			PCOLR2 = $2C2
    35 = 02C3			PCOLR3 = $2C3
    36 = 02C4			COLOR0 = $2C4
    37 = 02C5			COLOR1 = $2C5
    38 = 02C6			COLOR2 = $2C6
    39 = 02C7			COLOR3 = $2C7
    40 = 02C8			COLOR4 = $2C8
    41 = 02F4			CHBAS = $2F4
    42
    43 				; ************************ VARIABLES ****************************
    44
    45 = 000C			DOSINI		equ $0C
    46 = 02E7			MEMLO		equ $02E7
    47 = 02E0			RunVec		equ $02E0
    48 = 02E2			IniVec		equ $02E2
    49 = D40B			VCOUNT		equ $D40B
    50 = D40A			WSYNC		equ $D40A
    51 = 03FA			GINTLK		equ $03FA
    52 = D013			TRIG3		equ $D013
    53 = 0230			SDLSTL		equ $230
    54 = E456			CIOV		equ $E456
    55
    56 				; ************************ CODE ****************************
    57
    58
    59 					opt h-                     ;Disable Atari COM/XEX file headers
    60
    61 					org $a000                  ;RD5 cartridge base
    62 					opt f+                     ;Activate fill mode
    63 				load_vram
    64 A000 A0 00 BA BD DC B0 + 	ins "FFL3_vram.xex", 6
    65 					
    66 B1A3				org $b1c0
    67 				;Cartridge initalization
    68 				;Only the minimum of the OS initialization is complete, you don't want to code here normally.
    69 B1C0			init    .proc
    70 B1C0 A9 34			lda #$34
    71 B1C2 8D C8 02			sta COLOR4
    72 B1C5 8D 1A D0			sta COLBAK
    73 B1C8 60				rts
    74 					.endp ; proc init
    75 					
    76 B1C9				org $b200
    77 				;Cartridge start
    78 				;Copy main code to RAM and transfer control there
    79 B200			start   .proc
    80 B200 A9 84			lda #$84
    81 B202 8D C8 02			sta COLOR4
    82 B205 8D 1A D0			sta COLBAK
    83 B208 20 11 B2			jsr copy_wait_for_cart
    84 B20B 20 28 B2			jsr copy_display_list
    85 B20E 4C 00 A0			jmp load_vram
    86 					.endp
    87 					
    88 B211			.proc	copy_wait_for_cart
    89 B211 A0 00			ldy #0
    90 B213			@
    91 B213 B9 00 BA			lda wait_for_cart,y
    92 B216 99 00 07			sta .ADR wait_for_cart,y
    93 B219 C8				iny
    94 B21A D0 F7			bne @-
    95 B21C B9 00 BB		@	lda wait_for_cart+$100,y
    96 B21F 99 00 08			sta .ADR wait_for_cart+$100,y
    97 B222 C8				iny
    98 B223 C0 AD			cpy #(.len[wait_for_cart] & 0xFF)
    99 B225 D0 F5			bne @-
   100 B227 60				rts
   101 					.endp
   102
   103 B228			.proc	copy_display_list
   104 B228 A0 00			ldy #0
   105 B22A			@
   106 B22A B9 00 BD			lda G15_dlist,y
   107 B22D 99 00 06			sta .ADR G15_dlist,y
   108 B230 C8				iny
   109 B231 C0 AD			cpy #.len[G15_dlist]
   110 B233 D0 F5			bne @-
   111 B235 60				rts
   112 					.endp
   113
   114 				.macro wait_cart_ready
   115 				@	lda $D5DE
   116 					lsr ; a
   117 					lsr ; a
   118 					lsr ; a
   119 					lsr ; a
   120 					tay
   121 					lda .ADR Hex2Screen,y
   122 					sta $6FE
   123 				@	lda $D5DE
   124 					and #$f
   125 					tay
   126 					lda .ADR Hex2Screen,y
   127 					sta $6FF
   128 					lda $D5DE
   129 					cmp #'X'
   130 					; wait for cart to become ready
   131 					bne @-
   132 					.endm
   133
   134 				.macro show_msg msg
   135 					ldy #<(.ADR :msg)
   136 					ldx #>(.ADR :msg)
   137 					jsr .ADR show_text
   138 					.endm
   139
   140 B236 FF FF FF FF FF FF + 	.align $ba00,$FF
   141 BA00				org $ba00, $700
   142
   143 				; cmd is in Accumulator
   144 BA00			.proc wait_for_cart
   145 BA00 A9 E4 8D C8 02		mva #$E4 COLOR4
   146 BA05				show_msg MsgWaitCart
Macro: SHOW_MSG [Source: Mode7FFL3.asm]
     1 BA05 A0 5F			ldy #<(.ADR MSGWAITCART)
     2 BA07 A2 08			ldx #>(.ADR MSGWAITCART)
     3 BA09 20 17 08			jsr .ADR show_text
Source: Mode7FFL3.asm
   147 					; dlist toggler
   148 BA0C A2 06			ldx #>(.ADR G15_dlist)
   149 BA0E A9 00			lda #<(.ADR G15_dlist)
   150 BA10 8E 31 02			stx $231
   151 BA13 8D 30 02			sta $230
   152 BA16 20 FB 07			jsr .ADR wait_for_vbi
   153
   154 BA19				wait_cart_ready
Macro: WAIT_CART_READY [Source: Mode7FFL3.asm]
     1 BA19 AD DE D5		@	lda $D5DE
     2 BA1C 4A				lsr ; a
     3 BA1D 4A				lsr ; a
     4 BA1E 4A				lsr ; a
     5 BA1F 4A				lsr ; a
     6 BA20 A8				tay
     7 BA21 B9 9D 08			lda .ADR Hex2Screen,y
     8 BA24 8D FE 06			sta $6FE
     9 BA27 AD DE D5		@	lda $D5DE
    10 BA2A 29 0F			and #$f
    11 BA2C A8				tay
    12 BA2D B9 9D 08			lda .ADR Hex2Screen,y
    13 BA30 8D FF 06			sta $6FF
    14 BA33 AD DE D5			lda $D5DE
    15 BA36 C9 58			cmp #'X'
    17 BA38 D0 ED			bne @-
Source: Mode7FFL3.asm
   155 					
   156 BA3A A9 1A 8D C4 02		mva #$1A COLOR0
   157 BA3F A9 16 8D C5 02		mva #$16 COLOR1
   158 BA44 A9 12 8D C6 02		mva #$12 COLOR2
   159 BA49 8D C8 02			sta COLOR4
   160 BA4C A9 00 8D C7 02		mva #$00 COLOR3 ; unused
   161
   162 BA51 20 FB 07			jsr .ADR wait_for_vbi
   163 BA54 AD 2F 02			lda SDMCTL
   164 BA57 48				pha
   165 BA58 A9 00			lda #0
   166 BA5A 8D 0E D4			sta NMIEN
   167 BA5D 8D 2F 02			sta SDMCTL
   168 BA60 8D 00 D4			sta DMACTL
   169
   170 					; init vram (copy VRAM data)
   171 BA63 A9 31 8D DF D5		mva #CART_CMD_INIT_M7_VRAM $D5DF
   172 BA68				show_msg MsgInit
Macro: SHOW_MSG [Source: Mode7FFL3.asm]
     1 BA68 A0 75			ldy #<(.ADR MSGINIT)
     2 BA6A A2 08			ldx #>(.ADR MSGINIT)
     3 BA6C 20 17 08			jsr .ADR show_text
Source: Mode7FFL3.asm
   173 BA6F				wait_cart_ready
Macro: WAIT_CART_READY [Source: Mode7FFL3.asm]
     1 BA6F AD DE D5		@	lda $D5DE
     2 BA72 4A				lsr ; a
     3 BA73 4A				lsr ; a
     4 BA74 4A				lsr ; a
     5 BA75 4A				lsr ; a
     6 BA76 A8				tay
     7 BA77 B9 9D 08			lda .ADR Hex2Screen,y
     8 BA7A 8D FE 06			sta $6FE
     9 BA7D AD DE D5		@	lda $D5DE
    10 BA80 29 0F			and #$f
    11 BA82 A8				tay
    12 BA83 B9 9D 08			lda .ADR Hex2Screen,y
    13 BA86 8D FF 06			sta $6FF
    14 BA89 AD DE D5			lda $D5DE
    15 BA8C C9 58			cmp #'X'
    17 BA8E D0 ED			bne @-
Source: Mode7FFL3.asm
   174 					
   175 					; draw the initial screen
   176 BA90 A9 30 8D DF D5		mva #CART_CMD_REFRESH_M7_SCREEN $D5DF
   177 BA95				show_msg MsgRefresh
Macro: SHOW_MSG [Source: Mode7FFL3.asm]
     1 BA95 A0 87			ldy #<(.ADR MSGREFRESH)
     2 BA97 A2 08			ldx #>(.ADR MSGREFRESH)
     3 BA99 20 17 08			jsr .ADR show_text
Source: Mode7FFL3.asm
   178 BA9C				wait_cart_ready
Macro: WAIT_CART_READY [Source: Mode7FFL3.asm]
     1 BA9C AD DE D5		@	lda $D5DE
     2 BA9F 4A				lsr ; a
     3 BAA0 4A				lsr ; a
     4 BAA1 4A				lsr ; a
     5 BAA2 4A				lsr ; a
     6 BAA3 A8				tay
     7 BAA4 B9 9D 08			lda .ADR Hex2Screen,y
     8 BAA7 8D FE 06			sta $6FE
     9 BAAA AD DE D5		@	lda $D5DE
    10 BAAD 29 0F			and #$f
    11 BAAF A8				tay
    12 BAB0 B9 9D 08			lda .ADR Hex2Screen,y
    13 BAB3 8D FF 06			sta $6FF
    14 BAB6 AD DE D5			lda $D5DE
    15 BAB9 C9 58			cmp #'X'
    17 BABB D0 ED			bne @-
Source: Mode7FFL3.asm
   179 					
   180 BABD A9 1E			lda #$1E
   181 BABF 20 05 08			jsr .ADR set_bg_colour
   182 					
   183 BAC2 AD FD BF			lda $BFFD
   184 BAC5 C9 04			cmp #CARTFG_START_CART
   185 BAC7 D0 05			bne CartOK
   186 					; show green if boot rom still present
   187 BAC9 A9 CA			lda #$CA
   188 BACB 20 05 08			jsr .ADR set_bg_colour
   189
   190 BACE			CartOK
   191 BACE				show_msg MsgOk
Macro: SHOW_MSG [Source: Mode7FFL3.asm]
     1 BACE A0 9A			ldy #<(.ADR MSGOK)
     2 BAD0 A2 08			ldx #>(.ADR MSGOK)
     3 BAD2 20 17 08			jsr .ADR show_text
Source: Mode7FFL3.asm
   192 					; each VBI will ask for a redraw
   193 BAD5 A9 07			LDA #7
   194 BAD7 A2 08			LDX #>(.ADR VBI)
   195 BAD9 A0 2B			LDY #<(.ADR VBI)
   196 BADB 20 5C E4			JSR SETVBV
   197
   198 					; clear up old dlist
   199 BADE A0 7F			ldy #$7F
   200 BAE0 A9 00			lda #0
   201 BAE2 99 00 9C		@	sta $9C00,y
   202 BAE5 88				dey
   203 BAE6 10 FA			bpl @-
   204 					
   205 					; Restore DMA (screen turns on at next VBlank)
   206 BAE8 68				pla
   207 BAE9 8D 2F 02			sta SDMCTL
   208 					; enable dli's
   209 BAEC A9 C0 8D 0E D4		mva #$C0 NMIEN
   210 					
   211 BAF1			endless
   212 BAF1 A0 00			ldy #0
   213 BAF3			anim_loop
   214 					; delay
   215 BAF3 A9 0F			lda #15
   216 BAF5 20 FD 07			jsr .ADR wait_n_vbi
   217 BAF8 4C F1 07			jmp .ADR endless
   218
   219 BAFB			wait_for_vbi
   220 BAFB A9 01			lda #1
   221 BAFD			wait_n_vbi
   222 BAFD 18				clc
   223 BAFE 65 14			adc $14
   224 BB00			@
   225 BB00 C5 14			cmp $14
   226 BB02 D0 FC			bne @-
   227 BB04 60				rts
   228
   229 BB05			set_bg_colour
   230 BB05 8D C8 02			sta COLOR4
   231 BB08 8D 1A D0			sta COLBAK
   232 BB0B 60				rts
   233
   234 BB0C			clear_text
   235 BB0C A0 27			ldy #$27
   236 BB0E A9 00			lda #0
   237 BB10 99 D8 06		@	sta $6D8,y
   238 BB13 88				dey
   239 BB14 10 FA			bpl @-
   240 BB16 60				rts
   241
   242 BB17			show_text
   243 BB17 8C 20 08			sty .ADR st + 1
   244 BB1A 8E 21 08			stx .ADR st + 2
   245 BB1D A0 00			ldy #0
   246 BB1F B9 FF FF		st:	lda $ffff,y
   247 BB22 30 06			bmi @+
   248 BB24 99 D8 06			sta $6D8,y
   249 BB27 C8				iny
   250 BB28 10 F5			bpl st
   251 BB2A 60			@	rts
   252
   253 BB2B			VBI
   254 BB2B A9 0E 8D 1A D0		mva #$0E COLBAK ; white
   255 BB30 A9 30 8D DF D5		mva #CART_CMD_REFRESH_M7_SCREEN $D5DF
   256 BB35				wait_cart_ready
Macro: WAIT_CART_READY [Source: Mode7FFL3.asm]
     1 BB35 AD DE D5		@	lda $D5DE
     2 BB38 4A				lsr ; a
     3 BB39 4A				lsr ; a
     4 BB3A 4A				lsr ; a
     5 BB3B 4A				lsr ; a
     6 BB3C A8				tay
     7 BB3D B9 9D 08			lda .ADR Hex2Screen,y
     8 BB40 8D FE 06			sta $6FE
     9 BB43 AD DE D5		@	lda $D5DE
    10 BB46 29 0F			and #$f
    11 BB48 A8				tay
    12 BB49 B9 9D 08			lda .ADR Hex2Screen,y
    13 BB4C 8D FF 06			sta $6FF
    14 BB4F AD DE D5			lda $D5DE
    15 BB52 C9 58			cmp #'X'
    17 BB54 D0 ED			bne @-
Source: Mode7FFL3.asm
   257 BB56 AD C8 02 8D 1A D0		mva COLOR4 COLBAK
   258 BB5C 4C 62 E4			JMP XITVBV
   259
   260 BB5F			MsgWaitCart
   261 BB5F 37 61 69 74 69 6E + 	dta d'Waiting for Cartridge',$80
   262 BB75			MsgInit
   263 BB75 29 6E 69 74 69 61 + 	dta d'Initialising VRAM',$80
   264 BB87			MsgRefresh
   265 BB87 26 69 72 73 74 00 + 	dta d'First VRAM Refresh',$80
   266 BB9A			MsgOk
   267 BB9A 2F 2B 80			dta d'OK',$80
   268 BB9D			Hex2Screen
   269 BB9D 10 11 12 13 14 15 + 	dta d'0123456789ABCDEF'
   270
   271 					.endp
   272
   273 BBAD FF FF FF FF FF FF + 	.align $bd00,$FF
   274 BD00				org $bd00,$600 ;Dlist
   275 BD00			.proc G15_dlist
   276 BD00 70 70 70		:3	.byte $70
   277 BD03 42				.byte $42
   278 BD04 D8 06			.word $6D8
   279 BD06 4E				.byte $4E
   280 BD07 10 A0			.word $A010
   281 BD09 1E 1E 1E 1E 1E 1E + :84	.byte $1E
   282 BD5D 4E				.byte $4E
   283 BD5E 00 B0			.word $B000
   284 BD60 1E 1E 1E 1E 1E 1E + :74	.byte $1E
   285 BDAA 41				.byte $41
   286 BDAB 00 06			.word .ADR G15_dlist
   287 				.endp
   288
   289 				; ************************ CARTRIDGE CONTROL BLOCK *****************
   290
   291 BDAD FF FF FF FF FF FF + 	.align $bff8,$FF
   292 BFF8				org $bff8                 ;Cartridge control block
   293 BFF8 4D 37			.byte 'M', '7'		  ;Signal to the UNO Cart for MODE-7 VRAM support
   294 BFFA 00 B2			.word start               ;CARTCS
   295 BFFC 00				.byte 0                   ;CART
   296 BFFD 04				.byte CARTFG_START_CART   ;CARTFG
   297 BFFE C0 B1			.word init                ;CARTAD
