mads 2.0.6 build 58 (28 Jan 17)
Source: Mode7FFL3.asm
     1 				/* Mode-7 Demo ROM for use with UnoCart
     2 				 * by Mark Keates/Wrathchild@AtariAge
     3 				 * This file builds with WUDSN/MADS into an 8K Atari ROM
     4 				 * The 8k ROM is loaded with the Final Fantasy Legend III/VRAM:
     5 				 */
     5
     6
     7 = 0030			CART_CMD_REFRESH_M7_SCREEN = $30
     8 = 0031			CART_CMD_INIT_M7_VRAM = $31
     9 = 0032			CART_CMD_PREPARE_M7_SCREEN = $32
    10 = 0033			CART_CMD_PROCESS_M7_MOVEMENT = $33
    11
    12 				;@com.wudsn.ide.asm.outputfileextension=.rom
    13
    14 = 0080			CARTFG_DIAGNOSTIC_CART = $80       ;Flag value: Directly jump via CARTAD during RESET.
    15 = 0004			CARTFG_START_CART      = $04       ;Flag value: Jump via CARTAD and then via CARTCS.
    16 = 0001			CARTFG_BOOT            = $01       ;Flag value: Boot peripherals, then start the module.
    17
    18 = E45C			SETVBV = $E45C
    19 = E462			XITVBV = $E462
    20 = E477			COLDSV = $E477				; Coldstart (powerup) entry point
    21 = E474			WARMSV = $E474				; Warmstart entry point
    22
    23 = D01A			COLBAK = $D01A
    24 = D01F			CONSOL = $D01F
    25 = D301			PORTB = $D301
    26 = D400			DMACTL = $D400
    27 = D404			HSCROL = $D404
    28 = D407			PMBASE = $D407
    29 = D40E			NMIEN = $D40E
    30
    31 = 022F			SDMCTL = $22F
    32 = 026F			GPRIOR = $26F
    33 = 02C0			PCOLR0 = $2C0
    34 = 02C1			PCOLR1 = $2C1
    35 = 02C2			PCOLR2 = $2C2
    36 = 02C3			PCOLR3 = $2C3
    37 = 02C4			COLOR0 = $2C4
    38 = 02C5			COLOR1 = $2C5
    39 = 02C6			COLOR2 = $2C6
    40 = 02C7			COLOR3 = $2C7
    41 = 02C8			COLOR4 = $2C8
    42 = 02F4			CHBAS = $2F4
    43
    44 				; ************************ VARIABLES ****************************
    45
    46 = 000C			DOSINI		equ $0C
    47 = 02E7			MEMLO		equ $02E7
    48 = 02E0			RunVec		equ $02E0
    49 = 02E2			IniVec		equ $02E2
    50 = D40B			VCOUNT		equ $D40B
    51 = D40A			WSYNC		equ $D40A
    52 = 03FA			GINTLK		equ $03FA
    53 = D013			TRIG3		equ $D013
    54 = 0230			SDLSTL		equ $230
    55 = E456			CIOV		equ $E456
    56
    57 				; ************************ CODE ****************************
    58
    59
    60 					opt h-                     ;Disable Atari COM/XEX file headers
    61
    62 					org $a000                  ;RD5 cartridge base
    63 					opt f+                     ;Activate fill mode
    64 				load_vram
    65 A000 A0 00 BA BD DC B0 + 	ins "FFL3_vram.xex", 6
    66 					
    67 B1A3				org $b1c0
    68 				;Cartridge initalization
    69 				;Only the minimum of the OS initialization is complete, you don't want to code here normally.
    70 B1C0			init    .proc
    71 B1C0 A9 34			lda #$34
    72 B1C2 8D C8 02			sta COLOR4
    73 B1C5 8D 1A D0			sta COLBAK
    74 B1C8 60				rts
    75 					.endp ; proc init
    76 					
    77 B1C9				org $b200
    78 				;Cartridge start
    79 				;Copy main code to RAM and transfer control there
    80 B200			start   .proc
    81 B200 A9 84			lda #$84
    82 B202 8D C8 02			sta COLOR4
    83 B205 8D 1A D0			sta COLBAK
    84 B208 20 11 B2			jsr copy_wait_for_cart
    85 B20B 20 28 B2			jsr copy_display_list
    86 B20E 4C 00 A0			jmp load_vram
    87 					.endp
    88 					
    89 B211			.proc	copy_wait_for_cart
    90 B211 A0 00			ldy #0
    91 B213			@
    92 B213 B9 00 BA			lda wait_for_cart,y
    93 B216 99 00 07			sta .ADR wait_for_cart,y
    94 B219 C8				iny
    95 B21A D0 F7			bne @-
    96 B21C B9 00 BB		@	lda wait_for_cart+$100,y
    97 B21F 99 00 08			sta .ADR wait_for_cart+$100,y
    98 B222 C8				iny
    99 B223 C0 B3			cpy #(.len[wait_for_cart] & 0xFF)
   100 B225 D0 F5			bne @-
   101 B227 60				rts
   102 					.endp
   103
   104 B228			.proc	copy_display_list
   105 B228 A0 00			ldy #0
   106 B22A			@
   107 B22A B9 00 BD			lda G15_dlist,y
   108 B22D 99 00 06			sta .ADR G15_dlist,y
   109 B230 C8				iny
   110 B231 C0 D4			cpy #.len[G15_dlist]
   111 B233 D0 F5			bne @-
   112 B235 60				rts
   113 					.endp
   114
   115 				.macro wait_cart_ready
   116 				@	lda $D5DE
   117 					lsr ; a
   118 					lsr ; a
   119 					lsr ; a
   120 					lsr ; a
   121 					tay
   122 					lda .ADR Hex2Screen,y
   123 					sta $6FE
   124 					lda $D5DE
   125 					and #$f
   126 					tay
   127 					lda .ADR Hex2Screen,y
   128 					sta $6FF
   129 					lda $D5DE
   130 					cmp #'X'
   131 					; wait for cart to become ready
   132 					bne @-
   133 					.endm
   134
   135 				.macro show_msg msg
   136 					ldy #<(.ADR :msg)
   137 					ldx #>(.ADR :msg)
   138 					jsr .ADR show_text
   139 					.endm
   140
   141 B236 FF FF FF FF FF FF + 	.align $ba00,$FF
   142 BA00				org $ba00, $700
   143
   144 				; cmd is in Accumulator
   145 BA00			.proc wait_for_cart
   146 BA00 A9 E4 8D C8 02		mva #$E4 COLOR4
   147 BA05				show_msg MsgWaitCart
Macro: SHOW_MSG [Source: Mode7FFL3.asm]
     1 BA05 A0 4F			ldy #<(.ADR MSGWAITCART)
     2 BA07 A2 08			ldx #>(.ADR MSGWAITCART)
     3 BA09 20 04 08			jsr .ADR show_text
Source: Mode7FFL3.asm
   148 					; dlist toggler
   149 BA0C A2 06			ldx #>(.ADR G15_dlist)
   150 BA0E A9 00			lda #<(.ADR G15_dlist)
   151 BA10 8E 31 02			stx $231
   152 BA13 8D 30 02			sta $230
   153 BA16 20 F3 07			jsr .ADR wait_for_vbi
   154
   155 BA19				wait_cart_ready
Macro: WAIT_CART_READY [Source: Mode7FFL3.asm]
     1 BA19 AD DE D5		@	lda $D5DE
     2 BA1C 4A				lsr ; a
     3 BA1D 4A				lsr ; a
     4 BA1E 4A				lsr ; a
     5 BA1F 4A				lsr ; a
     6 BA20 A8				tay
     7 BA21 B9 A1 08			lda .ADR Hex2Screen,y
     8 BA24 8D FE 06			sta $6FE
     9 BA27 AD DE D5			lda $D5DE
    10 BA2A 29 0F			and #$f
    11 BA2C A8				tay
    12 BA2D B9 A1 08			lda .ADR Hex2Screen,y
    13 BA30 8D FF 06			sta $6FF
    14 BA33 AD DE D5			lda $D5DE
    15 BA36 C9 58			cmp #'X'
    17 BA38 D0 DF			bne @-
Source: Mode7FFL3.asm
   156 					
   157 BA3A A9 FA 8D C4 02		mva #$FA COLOR0
   158 BA3F A9 FE 8D C5 02		mva #$FE COLOR1
   159 BA44 A9 F0 8D C6 02		mva #$F0 COLOR2
   160 BA49 A9 00 8D C7 02		mva #$00 COLOR3 ; unused
   161 BA4E 8D C8 02			sta COLOR4
   162
   163 BA51 20 F3 07			jsr .ADR wait_for_vbi
   164 BA54 AD 2F 02			lda SDMCTL
   165 BA57 48				pha
   166 BA58 A9 00			lda #0
   167 BA5A 8D 0E D4			sta NMIEN
   168 BA5D 8D 2F 02			sta SDMCTL
   169 BA60 8D 00 D4			sta DMACTL
   170
   171 					; init vram (copy VRAM data)
   172 BA63 A9 31 8D DF D5		mva #CART_CMD_INIT_M7_VRAM $D5DF
   173 BA68				show_msg MsgInit
Macro: SHOW_MSG [Source: Mode7FFL3.asm]
     1 BA68 A0 65			ldy #<(.ADR MSGINIT)
     2 BA6A A2 08			ldx #>(.ADR MSGINIT)
     3 BA6C 20 04 08			jsr .ADR show_text
Source: Mode7FFL3.asm
   174 BA6F				wait_cart_ready
Macro: WAIT_CART_READY [Source: Mode7FFL3.asm]
     1 BA6F AD DE D5		@	lda $D5DE
     2 BA72 4A				lsr ; a
     3 BA73 4A				lsr ; a
     4 BA74 4A				lsr ; a
     5 BA75 4A				lsr ; a
     6 BA76 A8				tay
     7 BA77 B9 A1 08			lda .ADR Hex2Screen,y
     8 BA7A 8D FE 06			sta $6FE
     9 BA7D AD DE D5			lda $D5DE
    10 BA80 29 0F			and #$f
    11 BA82 A8				tay
    12 BA83 B9 A1 08			lda .ADR Hex2Screen,y
    13 BA86 8D FF 06			sta $6FF
    14 BA89 AD DE D5			lda $D5DE
    15 BA8C C9 58			cmp #'X'
    17 BA8E D0 DF			bne @-
Source: Mode7FFL3.asm
   175 					
   176 BA90 A9 F4			lda #$F4
   177 BA92 20 FD 07			jsr .ADR set_bg_colour
   178 					
   179 BA95 AD FD BF			lda $BFFD
   180 BA98 C9 04			cmp #CARTFG_START_CART
   181 BA9A D0 05			bne CartOK
   182 					; show green if boot rom still present
   183 BA9C A9 CA			lda #$CA
   184 BA9E 20 FD 07			jsr .ADR set_bg_colour
   185
   186 BAA1			CartOK
   187 BAA1				show_msg MsgOk
Macro: SHOW_MSG [Source: Mode7FFL3.asm]
     1 BAA1 A0 8A			ldy #<(.ADR MSGOK)
     2 BAA3 A2 08			ldx #>(.ADR MSGOK)
     3 BAA5 20 04 08			jsr .ADR show_text
Source: Mode7FFL3.asm
   188 					; each VBI will ask for a redraw
   189 BAA8 A9 07			LDA #7
   190 BAAA A2 08			LDX #>(.ADR VBI)
   191 BAAC A0 22			LDY #<(.ADR VBI)
   192 BAAE 20 5C E4			JSR SETVBV
   193
   194 					; clear up old dlist
   195 BAB1 A0 7F			ldy #$7F
   196 BAB3 A9 00			lda #0
   197 BAB5 99 00 9C		@	sta $9C00,y
   198 BAB8 88				dey
   199 BAB9 10 FA			bpl @-
   200 BABB 8C B1 08			sty .ADR frame
   201 					
   202 					; Restore DMA (screen turns on at next VBlank)
   203 BABE 68				pla
   204 BABF 8D 2F 02			sta SDMCTL
   205 					; enable vbi's
   206 BAC2 A9 40 8D 0E D4		mva #$40 NMIEN
   207 					
   208 BAC7			endless
   209 BAC7 A9 00			lda #0
   210 BAC9 8D B2 08			sta .ADR lock_vbi
   211 BACC 20 F3 07			jsr .ADR wait_for_vbi
   212 BACF				wait_cart_ready
Macro: WAIT_CART_READY [Source: Mode7FFL3.asm]
     1 BACF AD DE D5		@	lda $D5DE
     2 BAD2 4A				lsr ; a
     3 BAD3 4A				lsr ; a
     4 BAD4 4A				lsr ; a
     5 BAD5 4A				lsr ; a
     6 BAD6 A8				tay
     7 BAD7 B9 A1 08			lda .ADR Hex2Screen,y
     8 BADA 8D FE 06			sta $6FE
     9 BADD AD DE D5			lda $D5DE
    10 BAE0 29 0F			and #$f
    11 BAE2 A8				tay
    12 BAE3 B9 A1 08			lda .ADR Hex2Screen,y
    13 BAE6 8D FF 06			sta $6FF
    14 BAE9 AD DE D5			lda $D5DE
    15 BAEC C9 58			cmp #'X'
    17 BAEE D0 DF			bne @-
Source: Mode7FFL3.asm
   213 				;	lda .ADR frame
   214 				;	jsr .ADR set_bg_colour
   215 BAF0 4C C7 07			jmp .ADR endless
   216
   217 BAF3			wait_for_vbi
   218 BAF3 A9 01			lda #1
   219 BAF5			wait_n_vbi
   220 BAF5 18				clc
   221 BAF6 65 14			adc $14
   222 BAF8			@
   223 BAF8 C5 14			cmp $14
   224 BAFA D0 FC			bne @-
   225 BAFC 60				rts
   226
   227 BAFD			set_bg_colour
   228 BAFD 8D C8 02			sta COLOR4
   229 BB00 8D 1A D0			sta COLBAK
   230 BB03 60				rts
   231
   232 BB04			show_text
   233 BB04 8C 17 08			sty .ADR st + 1
   234 BB07 8E 18 08			stx .ADR st + 2
   235 BB0A A0 27			ldy #$27
   236 BB0C A9 00			lda #0
   237 BB0E 99 D8 06		@	sta $6D8,y
   238 BB11 88				dey
   239 BB12 10 FA			bpl @-
   240 BB14 A0 00			ldy #0
   241 BB16 B9 FF FF		st:	lda $ffff,y
   242 BB19 30 06			bmi @+
   243 BB1B 99 D8 06			sta $6D8,y
   244 BB1E C8				iny
   245 BB1F 10 F5			bpl st
   246 BB21 60			@	rts
   247
   248 BB22			VBI
   249 BB22 AD B2 08			lda .ADR lock_vbi
   250 BB25 F0 03			beq @+
   251 BB27 4C 62 E4			JMP XITVBV
   252 BB2A EE B2 08		@	inc .ADR lock_vbi
   253 				;	mva #$0E COLBAK ; white
   254 BB2D EE B1 08			inc .ADR frame
   255 BB30 AD B1 08			lda .ADR frame
   256 BB33 29 01			and #1
   257 BB35 09 10			ora #$10
   258 BB37 8D FA 06			sta $6fa
   259 BB3A 29 01			and #1
   260 BB3C D0 04			bne @+
   261 BB3E A9 32			lda #CART_CMD_PREPARE_M7_SCREEN
   262 BB40 D0 02			bne @+1
   263 BB42 A9 30		@	lda #CART_CMD_REFRESH_M7_SCREEN
   264 BB44 8D DF D5		@	sta $D5DF
   265 BB47 49 20			eor #$20
   266 BB49 8D FC 06			sta $6fc
   267 BB4C 4C 62 E4			JMP XITVBV
   268
   269 BB4F			MsgWaitCart
   270 BB4F 37 61 69 74 69 6E + 	dta d'Waiting for Cartridge',$80
   271 BB65			MsgInit
   272 BB65 29 6E 69 74 69 61 + 	dta d'Initialising VRAM',$80
   273 BB77			MsgRefresh
   274 BB77 26 69 72 73 74 00 + 	dta d'First VRAM Refresh',$80
   275 BB8A			MsgOk
   276 BB8A 35 2E 2F 0D 23 61 + 	dta d'UNO-Cart : Mode-7 Demo',$80
   277 BBA1			Hex2Screen
   278 BBA1 10 11 12 13 14 15 + 	dta d'0123456789ABCDEF'
   279
   280 BBB1 00			frame	.byte 0
   281 BBB2 00			lock_vbi	.byte 0
   282
   283 					.endp
   284
   285 BBB3 FF FF FF FF FF FF + 	.align $bd00,$FF
   286 BD00				org $bd00,$600 ;Dlist
   287 BD00			.proc G15_dlist
   288 BD00 70 70		:2	.byte $70
   289 BD02 42				.byte $42
   290 BD03 D8 06			.word $6D8
   291 BD05 4E				.byte $4E
   292 BD06 10 A0			.word $A010
   293 BD08 0E 0E 0E 0E 0E 0E + :101	.byte $E
   294 BD6D 4E				.byte $4E
   295 BD6E 00 B0			.word $B000
   296 BD70 0E 0E 0E 0E 0E 0E + :97	.byte $E
   297 BDD1 41				.byte $41
   298 BDD2 00 06			.word .ADR G15_dlist
   299 				.endp
   300
   301 				; ************************ CARTRIDGE CONTROL BLOCK *****************
   302
   303 BDD4 FF FF FF FF FF FF + 	.align $bff8,$FF
   304 BFF8				org $bff8                 ;Cartridge control block
   305 BFF8 4D 37			.byte 'M', '7'            ;Signal to the UNO Cart for MODE-7 VRAM support
   306 BFFA 00 B2			.word start               ;CARTCS
   307 BFFC 00				.byte 0                   ;CART
   308 BFFD 04				.byte CARTFG_START_CART   ;CARTFG
   309 BFFE C0 B1			.word init                ;CARTAD
